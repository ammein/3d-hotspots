/*
Auto-generated by: https://github.com/pmndrs/gltfjsx
Command: npx gltfjsx@6.5.3 ./public/model/model.glb -o ./src/components/Globe.jsx -T 
Files: ./public/model/model.glb [9.57MB] > /Users/ASN74/Documents/codes/Interactive Assets/3d-hotspots/src/components/model-transformed.glb [4.88MB] (49%)
*/

import { useEffect, useRef, useState } from "react";
import { useGLTF, useAnimations, PerspectiveCamera } from "@react-three/drei";
import { useThree } from "@react-three/fiber";
import { KTX2Loader } from "three-stdlib";
import withModelManagement from "./hoc/ModelManagement";
import Fog from "./Fog";
import { types } from "@theatre/core";
import { editable } from "@theatre/r3f";
import withTheatreManagement from "./hoc/TheatreManagement";

useGLTF.setDecoderPath(
	import.meta.env.VITE_BASE_URL + "/" + import.meta.env.VITE_LOCAL_DRACO_PATH
);

const ktx2Loader = new KTX2Loader();
ktx2Loader.setTranscoderPath(
	import.meta.env.VITE_BASE_URL + "/" + import.meta.env.VITE_LOCAL_KTX_PATH
);

const focalRangeDefault = 25.0;

const EditableCamera = editable(PerspectiveCamera, "perspectiveCamera");

/**
 * Model Component
 * @param {{ url: string, useDraco: boolean, useKTX2: boolean, zoom: number, animationNames: string[], hideItems: [] }} param0
 * @returns
 */
function Model({
	url,
	useDraco,
	useKTX2,
	animationNames = [],
	hideItems = [],
	...rest
}) {
	const { Fog: FogTheatre } = rest.theatre;
	const group = useRef();
	const { gl } = useThree();
	const { animations, scene } = useGLTF(url, useDraco, true, (loader) => {
		if (useKTX2) {
			loader.setKTX2Loader(ktx2Loader.detectSupport(gl));
		}
	});
	const { actions } = useAnimations(animations, group);

	useEffect(() => {
		if (actions && animationNames.length > 0) {
			animationNames.forEach((name) => {
				actions[name].play();
			});
		}

		if (hideItems.length > 0) {
			hideItems.forEach((item) => {
				scene.getObjectByName(item).visible = false;
			});
		}

		scene.traverse((object) => {
			if (object.type === "Mesh") {
				// console.log(object);
			}
		});
	}, [actions, scene, url, animationNames, hideItems, rest.wireframe]);

	useEffect(() => {
		if (url.length > 0) {
			console.log("Running Preload");
			useGLTF.preload(url);
		}
	}, []); // Run Once

	return (
		<>
			<EditableCamera
				theatreKey="Camera"
				makeDefault
				position={[0, 0, 5]}
				zoom={0.81}
			/>
			<primitive ref={group} object={scene} dispose={null} />
			<Fog
				focalRange={FogTheatre ? FogTheatre.focalRange : focalRangeDefault}
			/>
		</>
	);
}

const theatreJSModel = withTheatreManagement(Model, {
	Model: {
		Fog: {
			props: {
				focalRange: types.number(focalRangeDefault, {
					range: [0, 100],
				}),
			},
			options: {
				reconfigure: import.meta.env.DEV ? true : false,
			},
		},
	},
});

export default withModelManagement(theatreJSModel);
